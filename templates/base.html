{% load static %}
<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>{% block title %}Talkie{% endblock %}</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="{% block meta_description %}Incontra nuove persone attraverso chat random e condividi momenti con la community. Talkie è il social network per incontri autentici.{% endblock %}">
    <meta name="theme-color" content="#db2777">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Talkie">
    
    <!-- Manifest -->
    <link rel="manifest" href="{% static 'manifest.json' %}">
    
    <!-- Icons -->
    <link rel="icon" type="image/png" sizes="192x192" href="{% static 'icons/icon-192x192.png' %}">
    <link rel="apple-touch-icon" href="{% static 'icons/icon-192x192.png' %}">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        .animate-slide-in {
            animation: slideIn 0.3s ease-out;
        }
        
        /* Dark Mode */
        .dark {
            color-scheme: dark;
        }
        .dark body {
            background-color: #1f2937;
            color: #f9fafb;
        }
        .dark nav {
            background-color: #111827;
            border-bottom: 1px solid #374151;
        }
        .dark .bg-white {
            background-color: #1f2937;
        }
        .dark .text-gray-900 {
            color: #f9fafb;
        }
        .dark .text-gray-700 {
            color: #d1d5db;
        }
        .dark .text-gray-600 {
            color: #9ca3af;
        }
        .dark .text-gray-500 {
            color: #6b7280;
        }
        .dark .border-gray-200 {
            border-color: #374151;
        }
        .dark .bg-gray-50 {
            background-color: #111827;
        }
        .dark .bg-gray-100 {
            background-color: #1f2937;
        }
        .dark .shadow-md {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5), 0 2px 4px -1px rgba(0, 0, 0, 0.3);
        }
    </style>
</head>
<body class="bg-gray-50">
    {% if user.is_authenticated %}
    <nav class="bg-white shadow-md sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center space-x-8">
                    <a href="{% url 'feed' %}" class="text-2xl font-bold text-pink-600">
                        <i class="fas fa-heart"></i> Talkie
                    </a>
                    <div class="hidden md:flex space-x-4">
                        <a href="{% url 'feed' %}" class="text-gray-700 hover:text-pink-600 px-3 py-2 rounded-md text-sm font-medium">
                            <i class="fas fa-home"></i> Home
                        </a>
                        <a href="{% url 'stories_list' %}" class="text-gray-700 hover:text-pink-600 px-3 py-2 rounded-md text-sm font-medium relative">
                            <i class="fas fa-fire"></i> Stories
                            <span id="stories-badge" class="hidden absolute top-0 right-0 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-white transform translate-x-1/2 -translate-y-1/2 bg-red-600 rounded-full">
                                0
                            </span>
                        </a>
                        <a href="{% url 'trending' %}" class="text-gray-700 hover:text-pink-600 px-3 py-2 rounded-md text-sm font-medium">
                            <i class="fas fa-hashtag"></i> Trending
                        </a>
                        <a href="{% url 'groups_list' %}" class="text-gray-700 hover:text-pink-600 px-3 py-2 rounded-md text-sm font-medium">
                            <i class="fas fa-users"></i> Gruppi
                        </a>
                        <a href="{% url 'random_chat' %}" class="text-gray-700 hover:text-pink-600 px-3 py-2 rounded-md text-sm font-medium">
                            <i class="fas fa-random"></i> Random
                        </a>
                        <a href="{% url 'notifications' %}" class="text-gray-700 hover:text-pink-600 px-3 py-2 rounded-md text-sm font-medium relative">
                            <i class="fas fa-bell"></i> Notifiche
                            <span id="notification-badge" class="hidden absolute top-0 right-0 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-white transform translate-x-1/2 -translate-y-1/2 bg-red-600 rounded-full">
                                0
                            </span>
                        </a>
                        <a href="{% url 'chat_list' %}" class="text-gray-700 hover:text-pink-600 px-3 py-2 rounded-md text-sm font-medium relative">
                            <i class="fas fa-comments"></i> Chat
                            <span id="chat-badge" class="hidden absolute top-0 right-0 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-white transform translate-x-1/2 -translate-y-1/2 bg-red-600 rounded-full">
                                0
                            </span>
                        </a>
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="hidden md:flex items-center space-x-4">
                        <a href="{% url 'search' %}" class="text-gray-700 hover:text-pink-600">
                            <i class="fas fa-search"></i>
                        </a>
                        <a href="{% url 'user_achievements' %}" class="text-gray-700 hover:text-yellow-600" title="Achievement">
                            <i class="fas fa-trophy"></i>
                        </a>
                        <button onclick="toggleDarkMode()" class="text-gray-700 hover:text-pink-600" title="Dark Mode">
                            <i class="fas fa-moon" id="darkModeIcon"></i>
                        </button>
                        <div class="relative">
                            <button class="flex items-center space-x-2 text-gray-700 hover:text-pink-600" onclick="toggleDropdown()">
                                <img src="{% if user.profile.profile_picture %}{{ user.profile.profile_picture.url }}{% else %}/media/profile_pics/default.jpg{% endif %}" alt="{{ user.username }}" class="w-8 h-8 rounded-full object-cover">
                                <i class="fas fa-chevron-down text-xs"></i>
                            </button>
                            <div id="userDropdown" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-50">
                                <a href="{% url 'profile' user.username %}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                    <i class="fas fa-user mr-2"></i> Il mio profilo
                                </a>
                                <a href="{% url 'user_achievements' %}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                    <i class="fas fa-trophy mr-2"></i> I miei Achievement
                                </a>
                                <a href="{% url 'leaderboard' %}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                    <i class="fas fa-crown mr-2"></i> Classifica
                                </a>
                                <a href="{% url 'edit_profile' %}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                    <i class="fas fa-cog mr-2"></i> Impostazioni
                                </a>
                                <a href="{% url 'logout' %}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                    <i class="fas fa-sign-out-alt mr-2"></i> Logout
                                </a>
                            </div>
                        </div>
                    </div>

                    <button id="mobileMenuButton" type="button" class="md:hidden inline-flex items-center gap-2 px-3 py-2 rounded-md text-gray-700 hover:text-pink-600 hover:bg-gray-100" aria-controls="mobileMenu" aria-expanded="false" onclick="toggleMobileMenu()">
                        <i class="fas fa-bars text-xl"></i>
                        <span class="text-sm font-medium">Menu</span>
                    </button>
                </div>
            </div>
        </div>

        <div id="mobileMenu" class="hidden md:hidden border-t border-gray-200 bg-white">
            <div class="px-4 py-3 space-y-1">
                <a href="{% url 'feed' %}" class="block px-3 py-2 rounded-md text-gray-700 hover:bg-gray-100">
                    <i class="fas fa-home"></i> Home
                </a>
                <a href="{% url 'stories_list' %}" class="block px-3 py-2 rounded-md text-gray-700 hover:bg-gray-100 relative">
                    <i class="fas fa-fire"></i> Stories
                    <span id="stories-badge-menu" class="hidden absolute top-2 right-3 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-white bg-red-600 rounded-full">
                        0
                    </span>
                </a>
                <a href="{% url 'trending' %}" class="block px-3 py-2 rounded-md text-gray-700 hover:bg-gray-100">
                    <i class="fas fa-hashtag"></i> Trending
                </a>
                <a href="{% url 'groups_list' %}" class="block px-3 py-2 rounded-md text-gray-700 hover:bg-gray-100">
                    <i class="fas fa-users"></i> Gruppi
                </a>
                <a href="{% url 'random_chat' %}" class="block px-3 py-2 rounded-md text-gray-700 hover:bg-gray-100">
                    <i class="fas fa-random"></i> Random Chat
                </a>
                <a href="{% url 'notifications' %}" class="block px-3 py-2 rounded-md text-gray-700 hover:bg-gray-100 relative">
                    <i class="fas fa-bell"></i> Notifiche
                    <span id="notification-badge-menu" class="hidden absolute top-2 right-3 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-white bg-red-600 rounded-full">
                        0
                    </span>
                </a>
                <a href="{% url 'chat_list' %}" class="block px-3 py-2 rounded-md text-gray-700 hover:bg-gray-100 relative">
                    <i class="fas fa-comments"></i> Chat
                    <span id="chat-badge-menu" class="hidden absolute top-2 right-3 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-white bg-red-600 rounded-full">
                        0
                    </span>
                </a>
                <a href="{% url 'search' %}" class="block px-3 py-2 rounded-md text-gray-700 hover:bg-gray-100">
                    <i class="fas fa-search"></i> Cerca
                </a>
                <a href="{% url 'user_achievements' %}" class="block px-3 py-2 rounded-md text-gray-700 hover:bg-gray-100">
                    <i class="fas fa-trophy"></i> Achievement
                </a>
                <button type="button" onclick="toggleDarkMode()" class="w-full text-left block px-3 py-2 rounded-md text-gray-700 hover:bg-gray-100">
                    <i class="fas fa-moon"></i> Dark Mode
                </button>

                <div class="border-t border-gray-200 mt-2 pt-2">
                    <a href="{% url 'profile' user.username %}" class="block px-3 py-2 rounded-md text-gray-700 hover:bg-gray-100">
                        <i class="fas fa-user"></i> Il mio profilo
                    </a>
                    <a href="{% url 'leaderboard' %}" class="block px-3 py-2 rounded-md text-gray-700 hover:bg-gray-100">
                        <i class="fas fa-crown"></i> Classifica
                    </a>
                    <a href="{% url 'edit_profile' %}" class="block px-3 py-2 rounded-md text-gray-700 hover:bg-gray-100">
                        <i class="fas fa-cog"></i> Impostazioni
                    </a>
                    <a href="{% url 'privacy_policy' %}" class="block px-3 py-2 rounded-md text-gray-700 hover:bg-gray-100">
                        <i class="fas fa-shield-alt"></i> Privacy Policy
                    </a>
                    <a href="{% url 'logout' %}" class="block px-3 py-2 rounded-md text-gray-700 hover:bg-gray-100">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </a>
                </div>
            </div>
        </div>
    </nav>
    {% endif %}

    {% if messages %}
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-4">
        {% for message in messages %}
        <div class="{% if message.tags == 'error' %}bg-red-100 border-red-400 text-red-700{% elif message.tags == 'success' %}bg-green-100 border-green-400 text-green-700{% else %}bg-blue-100 border-blue-400 text-blue-700{% endif %} border px-4 py-3 rounded relative mb-4" role="alert">
            <span class="block sm:inline">{{ message }}</span>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <main class="{% if user.is_authenticated %}py-6 md:py-8 pb-[calc(6rem+env(safe-area-inset-bottom))] md:pb-8{% endif %}">
        {% block content %}{% endblock %}
    </main>

    {% if user.is_authenticated %}
    <nav class="md:hidden fixed bottom-0 left-0 right-0 bg-white/95 backdrop-blur border-t border-gray-200 z-50" style="padding-bottom: env(safe-area-inset-bottom);">
        <div class="max-w-7xl mx-auto px-2">
            <div class="grid grid-cols-5">
                <a href="{% url 'feed' %}" class="flex flex-col items-center justify-center py-3 text-gray-600 hover:text-pink-600">
                    <i class="fas fa-home text-lg"></i>
                    <span class="text-[11px] mt-1">Home</span>
                </a>
                <a href="{% url 'search' %}" class="flex flex-col items-center justify-center py-3 text-gray-600 hover:text-pink-600">
                    <i class="fas fa-search text-lg"></i>
                    <span class="text-[11px] mt-1">Cerca</span>
                </a>
                <a href="{% url 'create_story' %}" class="flex flex-col items-center justify-center py-3 text-gray-600 hover:text-pink-600">
                    <i class="fas fa-plus-circle text-2xl"></i>
                    <span class="text-[11px] mt-0.5">Crea</span>
                </a>
                <a href="{% url 'notifications' %}" class="flex flex-col items-center justify-center py-3 text-gray-600 hover:text-pink-600 relative">
                    <i class="fas fa-bell text-lg"></i>
                    <span class="text-[11px] mt-1">Notifiche</span>
                    <span id="notification-badge-mobile" class="hidden absolute top-1 right-5 inline-flex items-center justify-center px-1.5 py-0.5 text-[10px] font-bold leading-none text-white bg-red-600 rounded-full">
                        0
                    </span>
                </a>
                <a href="{% url 'profile' user.username %}" class="flex flex-col items-center justify-center py-3 text-gray-600 hover:text-pink-600">
                    <img src="{% if user.profile.profile_picture %}{{ user.profile.profile_picture.url }}{% else %}/media/profile_pics/default.jpg{% endif %}" alt="{{ user.username }}" class="w-6 h-6 rounded-full object-cover">
                    <span class="text-[11px] mt-1">Profilo</span>
                </a>
            </div>
        </div>
    </nav>

    <script>
        // WebSocket per notifiche real-time
        const wsScheme = window.location.protocol === 'https:' ? 'wss' : 'ws';
        const notificationSocket = new WebSocket(
            wsScheme + '://' + window.location.host + '/ws/notifications/'
        );

        notificationSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            
            if (data.type === 'notification') {
                showNotificationToast(data.notification);
                refreshNotificationBadge();
            } else if (data.type === 'new_post') {
                showNewPostToast(data.post);
            } else if (data.type === 'new_comment') {
                showNewCommentToast(data.comment);
            } else if (data.type === 'refresh_counts') {
                refreshAllNavbarBadges();
            }
        };

        notificationSocket.onclose = function(e) {
            console.error('Notification socket closed');
        };

        function showNotificationToast(notification) {
            const toast = document.createElement('div');
            toast.className = 'fixed top-20 right-4 bg-white shadow-lg rounded-lg p-4 max-w-sm z-50 border-l-4 border-pink-600 animate-slide-in';
            toast.innerHTML = `
                <div class="flex items-start">
                    <i class="fas fa-bell text-pink-600 text-xl mr-3 mt-1"></i>
                    <div class="flex-1">
                        <p class="font-semibold text-gray-900">${notification.message}</p>
                        <p class="text-sm text-gray-500">Adesso</p>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 5000);
        }

        function setNotificationBadgeCount(count) {
            const badge = document.getElementById('notification-badge');
            const badgeMobile = document.getElementById('notification-badge-mobile');
            const badgeMenu = document.getElementById('notification-badge-menu');
            const normalized = Math.max(0, parseInt(count) || 0);

            const apply = (el) => {
                if (!el) return;
                el.textContent = normalized;
                if (normalized > 0) {
                    el.classList.remove('hidden');
                } else {
                    el.classList.add('hidden');
                }
            };

            apply(badge);
            apply(badgeMobile);
            apply(badgeMenu);
        }

        function setStoriesBadgeCount(count) {
            const badge = document.getElementById('stories-badge');
            const badgeMenu = document.getElementById('stories-badge-menu');
            const normalized = Math.max(0, parseInt(count) || 0);

            const apply = (el) => {
                if (!el) return;
                el.textContent = normalized;
                if (normalized > 0) {
                    el.classList.remove('hidden');
                } else {
                    el.classList.add('hidden');
                }
            };

            apply(badge);
            apply(badgeMenu);
        }

        function setChatBadgeCount(count) {
            const badge = document.getElementById('chat-badge');
            const badgeMenu = document.getElementById('chat-badge-menu');
            const normalized = Math.max(0, parseInt(count) || 0);

            const apply = (el) => {
                if (!el) return;
                el.textContent = normalized;
                if (normalized > 0) {
                    el.classList.remove('hidden');
                } else {
                    el.classList.add('hidden');
                }
            };

            apply(badge);
            apply(badgeMenu);
        }

        async function refreshNotificationBadge() {
            try {
                const res = await fetch('{% url "api_unread_notifications_count" %}', {
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                });
                if (!res.ok) return;
                const data = await res.json();
                setNotificationBadgeCount(data.unread_count);
            } catch (err) {
                // ignore
            }
        }

        async function refreshStoriesBadge() {
            try {
                const res = await fetch('{% url "api_unread_stories_count" %}', {
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                });
                if (!res.ok) return;
                const data = await res.json();
                setStoriesBadgeCount(data.unread_count);
            } catch (err) {
                // ignore
            }
        }

        async function refreshChatBadge() {
            try {
                const res = await fetch('{% url "api_unread_chat_count" %}', {
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                });
                if (!res.ok) return;
                const data = await res.json();
                setChatBadgeCount(data.unread_count);
            } catch (err) {
                // ignore
            }
        }

        function refreshAllNavbarBadges() {
            refreshNotificationBadge();
            refreshStoriesBadge();
            refreshChatBadge();
        }

        document.addEventListener('DOMContentLoaded', function() {
            refreshAllNavbarBadges();

            if (window.location.pathname === '{% url "notifications" %}') {
                setNotificationBadgeCount(0);
            }
            if (window.location.pathname === '{% url "stories_list" %}') {
                setStoriesBadgeCount(0);
            }
            if (window.location.pathname === '{% url "chat_list" %}') {
                refreshChatBadge();
            }
        });

        function toggleDropdown() {
            document.getElementById('userDropdown').classList.toggle('hidden');
        }

        function toggleMobileMenu() {
            const menu = document.getElementById('mobileMenu');
            const btn = document.getElementById('mobileMenuButton');
            if (menu) {
                menu.classList.toggle('hidden');
                if (btn) {
                    const expanded = !menu.classList.contains('hidden');
                    btn.setAttribute('aria-expanded', expanded ? 'true' : 'false');
                }
            }
        }

        function closeMobileMenu() {
            const menu = document.getElementById('mobileMenu');
            const btn = document.getElementById('mobileMenuButton');
            if (menu) {
                menu.classList.add('hidden');
                if (btn) {
                    btn.setAttribute('aria-expanded', 'false');
                }
            }
        }

        document.addEventListener('click', function(e) {
            const dropdown = document.getElementById('userDropdown');
            if (dropdown && !e.target.closest('.relative')) {
                dropdown.classList.add('hidden');
            }

            const mobileMenu = document.getElementById('mobileMenu');
            if (mobileMenu && !mobileMenu.classList.contains('hidden')) {
                const nav = document.querySelector('nav');
                if (nav && !e.target.closest('nav')) {
                    closeMobileMenu();
                }
            }
        });

        document.addEventListener('DOMContentLoaded', function() {
            const mobileMenu = document.getElementById('mobileMenu');
            if (mobileMenu) {
                mobileMenu.querySelectorAll('a').forEach((a) => {
                    a.addEventListener('click', () => closeMobileMenu());
                });
            }
        });

        // Dark Mode
        function toggleDarkMode() {
            const html = document.documentElement;
            const icon = document.getElementById('darkModeIcon');
            
            if (html.classList.contains('dark')) {
                html.classList.remove('dark');
                icon.classList.remove('fa-sun');
                icon.classList.add('fa-moon');
                localStorage.setItem('darkMode', 'false');
            } else {
                html.classList.add('dark');
                icon.classList.remove('fa-moon');
                icon.classList.add('fa-sun');
                localStorage.setItem('darkMode', 'true');
            }
        }

        // Load dark mode preference
        if (localStorage.getItem('darkMode') === 'true') {
            document.documentElement.classList.add('dark');
            const icon = document.getElementById('darkModeIcon');
            if (icon) {
                icon.classList.remove('fa-moon');
                icon.classList.add('fa-sun');
            }
        }

        function showNewPostToast(post) {
            const toast = document.createElement('div');
            toast.className = 'fixed top-20 right-4 bg-white shadow-lg rounded-lg p-4 max-w-md z-50 border-l-4 border-blue-600 animate-slide-in cursor-pointer hover:shadow-xl transition';
            toast.onclick = function() {
                window.location.href = `/profile/${post.author}/`;
            };
            toast.innerHTML = `
                <div class="flex items-start">
                    <i class="fas fa-plus-circle text-blue-600 text-xl mr-3 mt-1"></i>
                    <div class="flex-1">
                        <p class="font-semibold text-gray-900">${escapeHtml(post.message)}</p>
                        <p class="text-sm text-gray-700 mt-1">${escapeHtml(post.content)}</p>
                        ${post.has_image ? '<p class="text-xs text-gray-500 mt-1"><i class="fas fa-image"></i> Con immagine</p>' : ''}
                        <p class="text-xs text-gray-500 mt-2">Clicca per visualizzare</p>
                    </div>
                    <button onclick="event.stopPropagation(); this.parentElement.parentElement.remove()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 8000);
        }

        function showNewCommentToast(comment) {
            const toast = document.createElement('div');
            toast.className = 'fixed top-20 right-4 bg-white shadow-lg rounded-lg p-4 max-w-md z-50 border-l-4 border-green-600 animate-slide-in cursor-pointer hover:shadow-xl transition';
            toast.onclick = function() {
                window.location.href = `/post/${comment.post_id}/`;
            };
            toast.innerHTML = `
                <div class="flex items-start">
                    <i class="fas fa-comment text-green-600 text-xl mr-3 mt-1"></i>
                    <div class="flex-1">
                        <p class="font-semibold text-gray-900">${escapeHtml(comment.message)}</p>
                        <p class="text-sm text-gray-700 mt-1">"${escapeHtml(comment.content)}"</p>
                        <p class="text-xs text-gray-500 mt-2">Clicca per visualizzare</p>
                    </div>
                    <button onclick="event.stopPropagation(); this.parentElement.parentElement.remove()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 8000);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
    {% endif %}

    <script>
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        function likePost(postId) {
            const csrftoken = getCookie('csrftoken');
            
            fetch(`/post/${postId}/like/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                const likeBtn = document.querySelector(`#like-btn-${postId}`);
                const likeCount = document.querySelector(`#like-count-${postId}`);
                
                if (data.liked) {
                    likeBtn.classList.remove('text-gray-500');
                    likeBtn.classList.add('text-red-500');
                } else {
                    likeBtn.classList.remove('text-red-500');
                    likeBtn.classList.add('text-gray-500');
                }
                
                likeCount.textContent = data.likes_count;
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }
    </script>

    <!-- Footer -->
    <footer class="bg-gray-50 border-t border-gray-200 mt-12 py-8 {% if user.is_authenticated %}mb-[calc(4rem+env(safe-area-inset-bottom))] md:mb-0{% endif %}">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-8 mb-8">
                <!-- About -->
                <div>
                    <h3 class="text-lg font-bold text-gray-900 mb-4">Talkie</h3>
                    <p class="text-sm text-gray-600 mb-4">
                        Il social network per incontri autentici attraverso chat random e connessioni genuine.
                    </p>
                    <div class="flex gap-3">
                        <a href="https://twitter.com/talkie" target="_blank" class="w-8 h-8 flex items-center justify-center bg-gray-200 hover:bg-pink-600 hover:text-white rounded-full transition">
                            <i class="fab fa-twitter"></i>
                        </a>
                        <a href="https://instagram.com/talkie" target="_blank" class="w-8 h-8 flex items-center justify-center bg-gray-200 hover:bg-pink-600 hover:text-white rounded-full transition">
                            <i class="fab fa-instagram"></i>
                        </a>
                        <a href="https://github.com/andresgrb-blip/talkie" target="_blank" class="w-8 h-8 flex items-center justify-center bg-gray-200 hover:bg-pink-600 hover:text-white rounded-full transition">
                            <i class="fab fa-github"></i>
                        </a>
                    </div>
                </div>
                
                <!-- Product -->
                <div>
                    <h3 class="text-lg font-bold text-gray-900 mb-4">Prodotto</h3>
                    <ul class="space-y-2 text-sm">
                        <li><a href="{% url 'about_us' %}" class="text-gray-600 hover:text-pink-600">Chi Siamo</a></li>
                        <li><a href="{% url 'blog_list' %}" class="text-gray-600 hover:text-pink-600">Blog</a></li>
                        {% if user.is_authenticated %}
                        <li><a href="{% url 'random_chat' %}" class="text-gray-600 hover:text-pink-600">Random Chat</a></li>
                        <li><a href="{% url 'feed' %}" class="text-gray-600 hover:text-pink-600">Feed</a></li>
                        {% else %}
                        <li><a href="{% url 'register' %}" class="text-gray-600 hover:text-pink-600">Registrati</a></li>
                        <li><a href="{% url 'login' %}" class="text-gray-600 hover:text-pink-600">Accedi</a></li>
                        {% endif %}
                    </ul>
                </div>
                
                <!-- Legal -->
                <div>
                    <h3 class="text-lg font-bold text-gray-900 mb-4">Legale</h3>
                    <ul class="space-y-2 text-sm">
                        <li><a href="{% url 'privacy_policy' %}" class="text-gray-600 hover:text-pink-600">Privacy Policy</a></li>
                        <li><a href="{% url 'privacy_policy' %}#gdpr" class="text-gray-600 hover:text-pink-600">Diritti GDPR</a></li>
                        <li><a href="mailto:privacy@talkie.ovh" class="text-gray-600 hover:text-pink-600">Richieste Privacy</a></li>
                    </ul>
                </div>
                
                <!-- Support -->
                <div>
                    <h3 class="text-lg font-bold text-gray-900 mb-4">Supporto</h3>
                    <ul class="space-y-2 text-sm">
                        <li><a href="mailto:support@talkie.ovh" class="text-gray-600 hover:text-pink-600">Contattaci</a></li>
                        <li><a href="{% url 'about_us' %}#faq" class="text-gray-600 hover:text-pink-600">FAQ</a></li>
                        <li><a href="https://github.com/andresgrb-blip/talkie/issues" target="_blank" class="text-gray-600 hover:text-pink-600">Segnala Bug</a></li>
                    </ul>
                </div>
            </div>
            
            <div class="pt-8 border-t border-gray-200 text-center text-sm text-gray-600">
                <p>© 2025 Talkie. Tutti i diritti riservati. Made with ❤️ for authentic connections.</p>
            </div>
        </div>
    </footer>

    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then((registration) => {
                        console.log('SW registered:', registration);
                    })
                    .catch((error) => {
                        console.log('SW registration failed:', error);
                    });
            });
        }
    </script>
</body>
</html>
