{% extends 'base.html' %}

{% block title %}Chat - Zone4Love{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-3 sm:px-4">
    <div class="mb-3">
        <a href="{% url 'chat_list' %}" class="text-pink-600 hover:text-pink-700">
            <i class="fas fa-arrow-left"></i> Torna alle chat
        </a>
    </div>

    <div class="bg-white rounded-lg shadow-md overflow-hidden flex flex-col h-[calc(100vh-12rem)] md:h-[70vh]">
        <div class="bg-pink-600 text-white p-4 flex items-center justify-between">
            <h2 class="text-xl font-bold">
                <i class="fas fa-comments"></i> {{ room_name }}
            </h2>
            <a href="{% url 'call_room' room_name %}" class="inline-flex items-center gap-2 px-3 py-2 bg-white/20 hover:bg-white/30 rounded-full text-sm font-medium">
                <i class="fas fa-video"></i>
                <span>Videochiama</span>
            </a>
        </div>

        <div id="chat-messages" class="flex-1 overflow-y-auto p-3 sm:p-4 space-y-4">
            <!-- Messages will be loaded here via WebSocket -->
        </div>

        <div class="border-t border-gray-200 p-3 sm:p-4">
            <form id="chat-form" class="flex space-x-2">
                <input 
                    type="text" 
                    id="chat-message-input" 
                    placeholder="Scrivi un messaggio..."
                    class="flex-1 px-4 py-2 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-pink-500"
                    autocomplete="off"
                    required
                >
                <button 
                    type="submit"
                    class="px-6 py-2 bg-pink-600 text-white rounded-full hover:bg-pink-700 transition font-medium"
                >
                    <i class="fas fa-paper-plane"></i> Invia
                </button>
            </form>
        </div>
    </div>
</div>

<script>
    const roomName = "{{ room_name }}";
    const currentUserId = parseInt("{{ user.id }}");
    const currentUsername = "{{ user.username }}";
    
    const wsScheme = window.location.protocol === 'https:' ? 'wss' : 'ws';
    const chatSocket = new WebSocket(
        wsScheme + '://' + window.location.host + '/ws/chat/' + roomName + '/'
    );

    const messagesContainer = document.getElementById('chat-messages');
    const messageForm = document.getElementById('chat-form');
    const messageInput = document.getElementById('chat-message-input');

    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        
        if (data.type === 'history') {
            data.messages.forEach(msg => {
                appendMessage(msg.message, msg.username, msg.user_id);
            });
        } else if (data.type === 'message') {
            appendMessage(data.message, data.username, data.user_id);
        }
    };

    chatSocket.onclose = function(e) {
        console.error('Chat socket closed unexpectedly');
    };

    messageForm.onsubmit = function(e) {
        e.preventDefault();
        const message = messageInput.value.trim();
        
        if (message) {
            chatSocket.send(JSON.stringify({
                'message': message
            }));
            messageInput.value = '';
        }
    };

    function appendMessage(message, username, userId) {
        const messageDiv = document.createElement('div');
        const isCurrentUser = userId === currentUserId;
        
        messageDiv.className = `flex ${isCurrentUser ? 'justify-end' : 'justify-start'}`;
        
        messageDiv.innerHTML = `
            <div class="max-w-xs lg:max-w-md">
                ${!isCurrentUser ? `<p class="text-xs text-gray-500 mb-1">${username}</p>` : ''}
                <div class="${isCurrentUser ? 'bg-pink-600 text-white' : 'bg-gray-200 text-gray-900'} rounded-lg px-4 py-2">
                    <p class="break-words">${escapeHtml(message)}</p>
                </div>
            </div>
        `;
        
        messagesContainer.appendChild(messageDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
</script>
{% endblock %}
