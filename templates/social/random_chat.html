{% extends 'base.html' %}

{% block title %}Random Chat - Talkie{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto px-3 sm:px-4">
    <div class="bg-white rounded-lg shadow-md p-4 sm:p-6">
        <div class="flex items-start justify-between gap-4">
            <div>
                <h1 class="text-2xl font-bold text-gray-900">Random Chat</h1>
                <p id="status" class="mt-1 text-sm text-gray-600">Pronto.</p>
            </div>
            <div class="text-right">
                <div class="text-xs text-gray-500">Partner</div>
                <div id="partner" class="text-sm font-semibold text-gray-900">-</div>
            </div>
        </div>

        <div class="mt-4 flex flex-col sm:flex-row gap-2">
            <button id="startBtn" type="button" class="w-full sm:w-auto px-4 py-2 rounded-full bg-pink-600 text-white hover:bg-pink-700 transition font-medium">
                Start
            </button>
            <button id="nextBtn" type="button" class="w-full sm:w-auto px-4 py-2 rounded-full bg-gray-200 text-gray-700 hover:bg-gray-300 transition font-medium" disabled>
                Next
            </button>
            <button id="stopBtn" type="button" class="w-full sm:w-auto px-4 py-2 rounded-full bg-red-600 text-white hover:bg-red-700 transition font-medium" disabled>
                Stop
            </button>
        </div>

        <div id="chat" class="mt-4 border border-gray-200 rounded-lg bg-gray-50 h-[50vh] md:h-[55vh] overflow-y-auto p-3 space-y-2"></div>

        <form id="sendForm" class="mt-3 flex gap-2" autocomplete="off">
            <input id="messageInput" type="text" class="flex-1 px-4 py-2 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-pink-500" placeholder="Scrivi un messaggio..." disabled />
            <button id="sendBtn" type="submit" class="px-4 py-2 rounded-full bg-pink-600 text-white hover:bg-pink-700 transition font-medium" disabled>
                Invia
            </button>
        </form>

        <div class="mt-4 text-xs text-gray-500">
            Consiglio: usa "Next" se non c\'Ã¨ feeling. Rispetta sempre l\'altro.
        </div>
    </div>
</div>

<script>
    const wsScheme = window.location.protocol === 'https:' ? 'wss' : 'ws';
    const socket = new WebSocket(wsScheme + '://' + window.location.host + '/ws/random/');

    const currentUserId = parseInt("{{ user.id }}");

    const statusEl = document.getElementById('status');
    const partnerEl = document.getElementById('partner');
    const chatEl = document.getElementById('chat');

    const startBtn = document.getElementById('startBtn');
    const nextBtn = document.getElementById('nextBtn');
    const stopBtn = document.getElementById('stopBtn');

    const sendForm = document.getElementById('sendForm');
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');

    let isMatched = false;

    function setStatus(text) {
        statusEl.textContent = text;
    }

    function setPartner(name) {
        partnerEl.textContent = name || '-';
    }

    function setControls({ queued, matched }) {
        isMatched = !!matched;

        startBtn.disabled = queued || matched;
        nextBtn.disabled = !matched;
        stopBtn.disabled = !(queued || matched);

        messageInput.disabled = !matched;
        sendBtn.disabled = !matched;

        if (!matched) {
            messageInput.value = '';
        }
    }

    function appendMessage({ username, message, mine }) {
        const row = document.createElement('div');
        row.className = mine ? 'flex justify-end' : 'flex justify-start';

        const bubble = document.createElement('div');
        bubble.className = mine
            ? 'max-w-[85%] bg-pink-600 text-white px-3 py-2 rounded-2xl rounded-br-md'
            : 'max-w-[85%] bg-white text-gray-900 px-3 py-2 rounded-2xl rounded-bl-md border border-gray-200';

        bubble.innerHTML = `<div class="text-[11px] opacity-80 mb-0.5">${username}</div><div class="text-sm break-words"></div>`;
        bubble.querySelector('div.text-sm').textContent = message;

        row.appendChild(bubble);
        chatEl.appendChild(row);
        chatEl.scrollTop = chatEl.scrollHeight;
    }

    startBtn.addEventListener('click', function() {
        socket.send(JSON.stringify({ type: 'start' }));
    });

    nextBtn.addEventListener('click', function() {
        chatEl.innerHTML = '';
        setPartner('-');
        setStatus('Cerco un altro match...');
        socket.send(JSON.stringify({ type: 'next' }));
        setControls({ queued: true, matched: false });
    });

    stopBtn.addEventListener('click', function() {
        socket.send(JSON.stringify({ type: 'stop' }));
    });

    sendForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const text = (messageInput.value || '').trim();
        if (!text) return;
        socket.send(JSON.stringify({ type: 'message', message: text }));
        appendMessage({ username: 'Tu', message: text, mine: true });
        messageInput.value = '';
    });

    socket.onmessage = function(e) {
        const data = JSON.parse(e.data);

        if (data.type === 'ready') {
            setStatus('Pronto. Premi Start per cercare un match.');
            setControls({ queued: false, matched: false });
            return;
        }

        if (data.type === 'queued') {
            setStatus('In coda... ti abbino appena trovo qualcuno.');
            setControls({ queued: true, matched: false });
            return;
        }

        if (data.type === 'matched') {
            chatEl.innerHTML = '';
            setPartner(data.partner?.username || 'Anon');
            setStatus('Match trovato!');
            setControls({ queued: false, matched: true });
            return;
        }

        if (data.type === 'message') {
            appendMessage({
                username: data.username,
                message: data.message,
                mine: (parseInt(data.user_id) === currentUserId),
            });
            return;
        }

        if (data.type === 'partner_left') {
            setStatus('Il partner ha lasciato. Premi Start o Next per un nuovo match.');
            setPartner('-');
            setControls({ queued: false, matched: false });
            return;
        }

        if (data.type === 'stopped') {
            setStatus('Fermato.');
            setPartner('-');
            setControls({ queued: false, matched: false });
            return;
        }
    };

    socket.onclose = function() {
        setStatus('Connessione chiusa. Ricarica la pagina.');
        setControls({ queued: false, matched: false });
    };
</script>
{% endblock %}
